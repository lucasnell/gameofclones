---
title: "Simulate cages"
author: "Lucas A. Nell"
date: "2018-07-03"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simulate cages}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svglite", 
  fig.width = 6,
  fig.height = 4
)
knitr::opts_knit$set(root.dir = normalizePath(".."))
options(tibble.print_min = 4L, tibble.print_max = 4L)
```
```{r source_Rprofile, echo = FALSE}
source(".Rprofile")
```

```{r library_pkgs, warning=FALSE}
suppressPackageStartupMessages({
    library(clonewars)
})
```


## Load dataset

```{r load_growth_dataset}
growth <- 
    load_data(impute_fxn = impute) %>%
    mutate(line = paste(line)) %>% 
    bind_rows(clonewars:::load_pz_data(impute_fxn = impute)) %>% 
    mutate_at(vars(line, rep), funs(factor)) %>% 
    # Now filter out early part of each time series, before N > 6
    # N <= 6 is when the stochasticity associated with only starting with 2 adults
    # appears to be strongest
    group_by(line, rep) %>% 
    filter(1:n() >= which(N > 6)[1]) %>%
    mutate(date = date - min(date)) %>%
    ungroup()
```


## Load stan fit data

```{r load_stan_fit_data}
stan_fit <- read_rds("data-raw/stan_fit.rds")
```



```{r}
n_plants <- 16
n_lines <- 8
N_0 <- matrix(rep(48/16, n_lines * n_plants), n_plants, n_lines)
max_t <- 180
R <- apply(rstan::extract(stan_fit, "R", permuted = FALSE), 3, mean) %>%
    as.numeric()
A <- apply(rstan::extract(stan_fit, "A", permuted = FALSE), 3, mean) %>%
    as.numeric()
D_slope <- disp_estimates$slope
D_inter <- disp_estimates$inter
process_error <- apply(rstan::extract(stan_fit, "s_epsilon", permuted = FALSE), 3, mean) %>%
    as.numeric()
plant_mort_slope <- clonewars::plant_death$after_max_mort_coefs$date
plant_mort_inter <- clonewars::plant_death$after_max_mort_coefs$inter
plant_death_age <- clonewars::plant_death$days_to_max
repl_every <- 4
plants_per <- 4  # plants to replace per replacement day
# Make even distribution of plants:
make_repl_plants <- function(repl_every, plants_per, n_plants, max_t) {
    n_groups <- ceiling(n_plants / plants_per)
    groups <- map(seq(1, n_plants, plants_per),
                  ~ (.x:(.x+plants_per-1)) %>% 
                      # Making sure none are beyond # plants:
                      .[. <= n_plants] %>% 
                      # Convert to C++ indices:
                      `-`(1))
    repl_times <- seq(repl_every, max_t, repl_every)
    which_group <- rep(1:n_groups, ceiling(length(repl_times) / n_groups)) %>% 
        .[1:length(repl_times)]
    return(map(which_group, function(i) groups[[i]]))
}
repl_times <- seq(repl_every, max_t, repl_every) - 1
repl_plants <- make_repl_plants(repl_every, plants_per, n_plants, max_t)
n_cages <- 100
n_cores <- parallel::detectCores() - 1
```


```{r do_sims}
set.seed(654651984L)
sim_df <- cwsims::sim_cages(n_cages, N_0, max_t, R, A, D_inter, D_slope, process_error,
                            plant_mort_inter, plant_mort_slope, plant_death_age,
                            repl_times, repl_plants, n_cores) %>% 
    mutate(X = log(N)) %>%
    identity()

sim_by_cage <- sim_df %>%
    mutate(line = factor(line,
                         levels = seq_along(levels(growth$line)),
                         labels = levels(growth$line)),
           rep = factor(rep)) %>% 
    group_by(rep, line, date) %>% 
    summarize(N = sum(N)) %>% 
    group_by(rep, date) %>% 
    arrange(line) %>% 
    mutate(prop = N / sum(N),
           prop_end = cumsum(prop),
           prop_start = lag(prop_end, default = 0)) %>%
    ungroup() %>% 
    mutate(X = log(N))
```


```{r plot_sims}


sim_by_cage %>% 
    filter(is.na(prop)) %>% 
    group_by(rep) %>% 
    summarize(date = min(date)) %>% 
    as.data.frame()

sim_by_cage %>%
    filter(
        (rep == 2    & date >= 44) |
        (rep == 13   & date >= 57) |
        (rep == 16   & date >= 49) |
        (rep == 26   & date >= 97) |
        (rep == 73   & date >= 72) |
        (rep == 76   & date >= 60)
    )
sim_by_cage %>% 
    filter(rep %in% c(2, 13, 16, 26, 73, 76)) %>% 
    ggplot(aes(date, N)) +
    geom_line(aes(color = line)) +
    facet_wrap(~ rep) +
    scale_color_brewer("Aphid line:", palette = "Dark2") +
    # coord_cartesian(ylim = c(0, 10)) +
    NULL




sim_df %>% 
    filter(rep == 1, date < 60) %>% 
    ggplot(aes(date, X)) +
    geom_line(aes(color = factor(line))) +
    facet_wrap(~ factor(plant)) +
    scale_color_brewer(palette = "Dark2") +
    NULL

sim_by_cage %>% 
    filter(rep %in% sample.int(n_cages, 12)) %>% 
    ggplot(aes(date, N)) +
    # ggplot(aes(date, X)) +
    geom_line(aes(color = line)) +
    facet_wrap(~ rep) +
    scale_color_brewer("Aphid line:", palette = "Dark2") +
    # coord_cartesian(ylim = c(0, 10)) +
    NULL


sim_by_cage %>% 
    filter(rep %in% 1:12) %>% 
    ggplot(aes(date, fill = line)) +
    geom_ribbon(aes(ymin = prop_start, ymax = prop_end), color = NA) +
    facet_wrap(~ rep, nrow = 4) +
    scale_fill_brewer("Aphid line:", palette = "Dark2") +
    NULL


sim_by_cage %>% 
    ggplot(aes(date, prop, color = line)) +
    # ggplot(aes(date, gtools::logit(prop), group = rep, color = line)) +
    geom_line(aes(group = rep), alpha = 0.25) +
    facet_wrap(~ line, ncol = 4) +
    # geom_smooth(method = "loess", se = FALSE, span = 0.4, color = "black", linetype = 2) +
    # stat_summary(geom = "line", fun.y = mean, color = "black", size = 0.5) +
    scale_color_brewer(palette = "Dark2", guide = FALSE) +
    ylab("Relative abundance") +
    xlab("Day") +
    NULL

sim_by_cage %>%
    group_by(rep, date) %>% 
    summarize(H = -sum(prop[prop > 0] * log(prop[prop > 0])),
              N = sum(prop > 0),
              E = H / log(N)) %>% 
    ungroup() %>% 
    ggplot(aes(date, H)) +
    geom_line(aes(group = rep), alpha = 0.25, color = "dodgerblue") +
    NULL




```

