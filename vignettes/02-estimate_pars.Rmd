---
title: "Estimating aphid population parameters"
author: "Lucas A. Nell"
date: "2018-07-03"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimating aphid population parameters}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svglite", 
  fig.width = 6,
  fig.height = 4
)
knitr::opts_knit$set(root.dir = normalizePath(".."))
options(tibble.print_min = 4L, tibble.print_max = 8L)
```
```{r source_Rprofile, echo = FALSE}
if (!isTRUE(getOption('knitr.in.progress'))) source(".Rprofile")
```

```{r library_pkgs, warning=FALSE, echo=FALSE}
suppressPackageStartupMessages({
    library(clonewars)
})
bayesplot::color_scheme_set("viridis")
```


This file will eventually contain the analyses to estimate aphid population-growth
parameters.
It is not yet finished, and much of the code below is not run during the making of
this document.


## Imputing missing data

See `?impute` for information on imputing missing data.


## Load data

```{r load_data}
growth <- 
    load_data() %>%
    # Now filter out early part of each time series, before N > 6
    # N <= 6 is when the stochasticity associated with only starting with 2 adults
    # appears to be strongest
    group_by(line, rep) %>% 
    filter(1:n() >= which(N > 6)[1]) %>%
    mutate(date = as.integer(date - min(date))) %>%
    ungroup()
```

This is how many reps I have of each line:

```{r view_reps, echo=FALSE}
growth %>% 
    group_by(line) %>% 
    summarize(n = rep %>% unique() %>% length()) %>% 
    knitr::kable()
```




## See time series data

```{r filter_data}
growth %>% 
    group_by(line) %>% 
    mutate(rep = map_int(rep, ~ which(sort(unique(rep)) == .x))) %>% 
    ungroup() %>% 
    mutate(rep = factor(rep)) %>% 
    ggplot(aes(date, X, color = rep)) +
    geom_line(size = 0.75) +
    geom_point(size = 0.75) +
    facet_wrap(~ line, nrow = 2) +
    scale_color_brewer(palette = "RdBu") +
    NULL
```






## Run model

```{r run_model, eval = TRUE}
# Takes ~ 30 sec
stan_fit <- fit_lines(growth,
                      seed = 65136, control = list(adapt_delta = 0.8))
```
```{r write_model, eval = FALSE, echo = FALSE}
write_rds(stan_fit, "data-raw/stan_fit.rds")
```
```{r read_model, eval = TRUE, echo = FALSE}
# stan_fit <- read_rds("data-raw/stan_fit.rds")
```


## Examine model output


```{r examine_model, message=FALSE}

# http://mc-stan.org/bayesplot/articles/visual-mcmc-diagnostics.html

posterior <- as.array(stan_fit)

mcmc_intervals(posterior, pars = sprintf("Z_r[%i]", 1:8)) +
    scale_y_discrete(labels = growth$line %>% levels()) +
    ggtitle("Growth rates")
# mcmc_intervals(posterior, pars = sprintf("Z_a_a[%i]", 1:8)) +
#     scale_y_discrete(labels = growth$line %>% levels()) +
#     ggtitle("Density dependences")
```


This code is looking at model output. I'm not including it yet in this vignette because
it's not ready.


```{r examine_model2, eval = FALSE}

for (i in 1:6) {
    x <- c("sigma_epsilon", "rho", "sigma_rho", "phi", "sigma_phi_a", "sigma_phi_w")[i]
    y <- theta[seq(2, length(theta),2)][i]
    z <- apply(rstan::extract(stan_fit, x, permuted = FALSE), 3, sd)
    cat(sprintf("parameter: %s\n prior SD:     %.5g\n posterior SD: %.5g\n\n", x, y, z))
}; rm(x,y,i)


growth %>% 
    arrange(line, rep, date) %>% 
    select(obs = X) %>% 
    mutate(pred = apply(rstan::extract(stan_fit, "X_pred", permuted = FALSE),
                        3, mean),
           resid = apply(rstan::extract(stan_fit, "X_resid", permuted = FALSE),
                        3, mean)) %>%
    # ggplot(aes(pred, obs)) +
    ggplot(aes(pred, resid)) +
    geom_point(shape = 1, alpha = 0.5) +
    # geom_abline(slope = 1, intercept = 0, color = "dodgerblue", linetype = 2,
    #             size = 1) +
    # annotate(geom = "text", x = 6.5, y = 7, label = "1:1 line", hjust = 1, vjust = 0,
    #          color = "dodgerblue", fontface = "bold") +
    geom_abline(slope = 0, intercept = 0, color = "dodgerblue", linetype = 2,
                size = 1) +
    xlab("predicted X") +
    # ylab("observed X") +
    ylab("residual") +
    NULL


cor_df <- data_frame(
    lp__ = as.numeric(rstan::extract(stan_fit, "lp__", permuted = FALSE)[,,1]),
    sigma_epsilon = as.numeric(rstan::extract(stan_fit, "sigma_epsilon",
                                              permuted = FALSE)[,,1]),
    rho = as.numeric(rstan::extract(stan_fit, "rho", permuted = FALSE)[,,1]),
    sigma_rho = as.numeric(rstan::extract(stan_fit, "sigma_rho", permuted = FALSE)[,,1]),
    phi = as.numeric(rstan::extract(stan_fit, "phi", permuted = FALSE)[,,1]),
    # sigma_phi_a = as.numeric(rstan::extract(stan_fit, "sigma_phi_a",
    #                                         permuted = FALSE)[,,1]),
    sigma_phi_w = as.numeric(rstan::extract(stan_fit, "sigma_phi_w",
                                            permuted = FALSE)[,,1]))


cp <- GGally::ggpairs(cor_df)
cp + theme(strip.text = element_text(size = 10, lineheight = 2, hjust = 0.5, vjust = 1))



apply(rstan::extract(stan_fit, "Z_r", permuted = FALSE), 3, mean)
apply(rstan::extract(stan_fit, "Z_a_a", permuted = FALSE), 3, mean)

apply(rstan::extract(stan_fit, "sigma_epsilon", permuted = FALSE), 3, mean)
apply(rstan::extract(stan_fit, "sigma_epsilon", permuted = FALSE), 3, quantile,
      probs = c(0.025, 0.975))



print(stan_fit, digits = 6, pars = c("Z_r", "Z_a_a", "sigma_epsilon"), probs = c())
print(stan_fit, digits = 6, pars = c("phi", "sigma_phi_a", "sigma_phi_w"), probs = c())


# parameters of interest
pars_interest <- c(#sprintf("Z_a_a[%i]", 1:8),
                   sprintf("Z_r[%i]", 1:8),
                   "rho", "sigma_rho",
                   "phi", "sigma_phi_a", "sigma_phi_w",
                   "sigma_epsilon")
non_ZX_pars <- names(stan_fit)[!grepl("^Z", names(stan_fit)) & 
                                   !grepl("^X", names(stan_fit))]


mcmc_areas(posterior, pars = non_ZX_pars[non_ZX_pars != "lp__" & non_ZX_pars != "phi"])

mcmc_areas(posterior, pars = "phi")
mcmc_areas(posterior, pars = "lp__")


rhat(stan_fit, pars = non_ZX_pars) %>% 
    mcmc_rhat() + yaxis_text(hjust = 1)
neff_ratio(stan_fit, pars = non_ZX_pars) %>% 
    mcmc_neff() + yaxis_text(hjust = 1)

rhat(stan_fit, pars = pars_interest) %>% 
    mcmc_rhat() + yaxis_text(hjust = 1)
neff_ratio(stan_fit, pars = pars_interest) %>% 
    mcmc_neff() + yaxis_text(hjust = 1)


# Rhats
rhats <- rhat(stan_fit, pars = pars_interest)
mcmc_rhat(rhats)  + yaxis_text(hjust = 1)

# Neff / N
neff_ratios <- neff_ratio(stan_fit, pars = pars_interest)
mcmc_neff(neff_ratios, size = 2) + yaxis_text(hjust = 1)


# Autocorrelation
mcmc_acf(posterior, pars = pars_interest[1:8], lags = 10)
mcmc_acf(posterior, pars = pars_interest[9:16], lags = 10)
mcmc_acf(posterior, pars = pars_interest[17:length(pars_interest)], lags = 10)


# # Only really useful if there were divergences:
# np <- NULL # nuts_params(stan_fit)
# lp <- log_posterior(stan_fit)
# mcmc_trace(posterior, pars = pars_interest[1:8], np = np)
# mcmc_trace(posterior, pars = pars_interest[9:16], np = np)
# mcmc_trace(posterior, pars = pars_interest[17:length(pars_interest)], np = np)
# 
# mcmc_nuts_divergence(np, lp)
# 
# mcmc_parcoord(posterior, np = np)
# 
# mcmc_scatter(
#   posterior,
#   pars = c("s_epsilon", "R[6]"),
#   transform = list(`R[6]` = "log"),
#   np = np
# )


growth %>% 
    group_by(line) %>% 
    summarize(n = length(unique(rep))) %>% 
    mutate(line = as.integer(line)) %>% 
    as.data.frame()


pred_df <- make_pred_df(stan_fit, growth)

pred_df %>%
    filter(rep == 1) %>%
    # filter(rep == 4, line == "Clover-2017-2") %>%
    ggplot(aes(date, X)) +
    geom_ribbon(aes(ymin = X_lower, ymax = X_upper),
                fill = "gray70", alpha = 0.5) +
    geom_line(color = "firebrick", alpha = 0.5) +
    geom_point(shape = 1, color = "firebrick", alpha = 0.5) +
    geom_line(aes(y = X_pred), color = "dodgerblue3", size = 0.5) +
    facet_wrap(~ rep + line, nrow = 2) +
    # facet_wrap(~ rep + line, nrow = 7) +
    coord_trans(y = "exp") +
    theme(strip.text = element_blank()) +
    NULL



```


