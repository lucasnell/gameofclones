---
title: "Estimating dispersal"
author: "Lucas A. Nell"
date: "2018-07-03"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimating dispersal}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svglite", 
  fig.width = 6,
  fig.height = 4
)
knitr::opts_knit$set(root.dir = normalizePath(".."))
options(tibble.print_min = 4L, tibble.print_max = 8L)
```
```{r source_Rprofile, echo = FALSE}
if (!isTRUE(getOption('knitr.in.progress'))) source(".Rprofile")
```

```{r library_pkgs, warning=FALSE, echo=TRUE}
suppressPackageStartupMessages({
    library(MASS)
    library(clonewars)
    library(lme4)
})
logit <- function(p) {
    suppressWarnings({x <- log(p/(1 - p))})
    # x <- ifelse(is.nan(x), NA, x)
    return(x)
}
inv_logit <- function(x) {
    p <- 1 / (1 + exp(-x))
    p <- ifelse(is.na(p) & !is.na(x), 1, p)
    return(p)
}
```


This file contains the analyses to estimate aphid dispersal.



## Load data

I don't need to do the same filtering when loading the dataset for dispersal estimates
as when loading data for population-growth parameter estimation.
The only filtering I need to do is removing the first day of counts when both
individuals were on the ground.


```{r load_data}
growth <- load_data(filter_pars = NULL,
                    remove_unfinished = FALSE) %>% 
    filter(date != 0) %>% 
    mutate(rep = factor(rep))
```


```{r growth_manip}
growth <- growth %>% 
    group_by(line, rep) %>% 
    arrange(date) %>% 
    mutate(disp = ifelse(is.na(disp), 0, disp),
           N = round(impute(N)),
           X = log(N),
           pN = N - disp,  # numbers of aphids on plant
           dD = disp - lag(disp, default = 0),
           dD = ifelse(dD < 0, 0, dD)) %>% 
    ungroup() %>% 
    arrange(line, rep, date) %>% 
    identity()
```


## View sample sizes

Below, `n_d` is the number of days where the number of dispersed individuals was
greater than zero.

```{r n_d_table}
growth %>% 
    group_by(line) %>% 
    summarize(n = rep %>% unique() %>% length(),
              n_d = sum(disp > 0)) %>% 
    knitr::kable()
```



## Dispersal ~ N plot

Below, colors represent different reps.


```{r disp_N_plot, warning=FALSE}
growth %>%
    mutate(pred = glm(cbind(dD, pN) ~ (0 + line) * X, family = "binomial", 
                      data = growth) %>% predict(type = "response")) %>% 
    ggplot(aes(x = X)) +
    geom_point(aes(y = dD / N, color = rep), shape = 16, alpha = 0.5) +
    geom_line(aes(y = pred), color = "black") +
    facet_wrap(~ line) +
    scale_color_brewer(palette = "Dark2", guide = FALSE) +
    NULL

growth %>%
    ggplot(aes(X, dD)) +
    geom_point(aes(color = rep), shape = 16, alpha = 0.5) +
    facet_wrap(~ line) +
    scale_color_brewer(palette = "Dark2", guide = FALSE) +
    NULL
```


## Fitting GLM

Fitting a binomial GLM of `new dispersed ~ X * line` (`X = log(N)`).


```{r fit_glmm, warning=FALSE}
disp_mod <- glm(cbind(dD, pN) ~ (0 + line) * X, data = growth, family = "binomial")
disp_mod %>% summary()
```


Estimates for each line:


```{r make_disp_mod_df, echo = FALSE}
nl <- growth$line %>% levels() %>% length()
disp_estimates <- disp_mod %>%
    coef() %>% 
    {names(.) <- gsub("line", "", names(.)); .} %>% 
    {
        cbind(head(., nl),
              .[(nl+1):(2*nl)])
    } %>% 
    as.data.frame() %>% 
    set_names(c("inter", "X")) %>% 
    rownames_to_column("line")

disp_estimates %>% 
    knitr::kable(digits = 3)
```




Code to make predictions from both models based on a vector of `N` and aphid line
names:

```{r prediction_fxn}
predict_disp <- function(N, aphid_line) {
    inds <- map_int(aphid_line, ~ which(disp_estimates$line == .x))
    # Binomial estimate (Pr(dispersal > 0)):
    b0 <- disp_estimates$inter[inds]
    b1 <- disp_estimates$X[inds]
    pr_disp <- inv_logit(b0 + b1 * log(N))
    return(pr_disp)
}
```


## Plotting predictions

```{r glmm_prediction_plot}
growth %>% 
    ggplot(aes(N, dD, color = rep)) +
    geom_point(alpha = 0.5, shape = 16) +
    geom_line(data = expand.grid(N = 1:1000,
                                 line = growth$line %>% unique() %>% sort()) %>% 
                  mutate(dD = N * predict_disp(N, line)),
        size = 0.75, color = "black") +
    scale_color_brewer(palette = "Dark2", guide = FALSE) +
    facet_wrap(~ line, nrow = 2) +
    scale_y_continuous("Dispersed aphids", trans = "log1p",
                       breaks = c(0, 4^(0:3))) +
    scale_x_continuous("Total aphids") +
    NULL
```


## Testing simulation

```{r sim_disp}
sim_disp <- function(N, aphid_line) {
    inds <- map_int(aphid_line, ~ which(disp_estimates$line == .x))
    # Binomial estimate (Pr(dispersal > 0)):
    b0 <- disp_estimates$inter[inds]
    b1 <- disp_estimates$X[inds]
    pr_disp <- inv_logit(b0 + b1 * log(N))
    n <- length(N)
    binom_rnd <- rbinom(n, N, pr_disp)
    return(binom_rnd)
}
```



```{r}
growth %>% 
    mutate(disp_ = sim_disp(N, line)) %>% 
    ggplot(aes(X, disp_, color = rep)) +
    geom_point(alpha = 0.5, shape = 16) +
    scale_color_brewer(palette = "Dark2", guide = FALSE) +
    facet_wrap(~ line, nrow = 2) +
    scale_y_continuous("Dispersed aphids", trans = "log1p",
                       breaks = c(0, 4^(0:3))) +
    scale_x_continuous("Total aphids") +
    NULL
# Other one to compare to:
growth %>% 
    ggplot(aes(X, dD, color = rep)) +
    geom_point(alpha = 0.5, shape = 16) +
    scale_color_brewer(palette = "Dark2", guide = FALSE) +
    facet_wrap(~ line, nrow = 2) +
    scale_y_continuous("Dispersed aphids", trans = "log1p",
                       breaks = c(0, 4^(0:3))) +
    scale_x_continuous("Total aphids") +
    NULL

growth %>% 
    mutate(disp_ = sim_disp(N, line)) %>% 
    summarize(mu = mean(disp_),
              sig = sd(disp_))
growth %>% 
    summarize(mu = mean(dD),
              sig = sd(dD))
```



## Saving output

```{r save_output, eval = FALSE}
devtools::use_data(disp_estimates, overwrite = TRUE)
```


