---
title: "Simulation description"
author: "Lucas A. Nell"
date: "2018-07-09"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simulation description}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svglite", 
  fig.width = 6,
  fig.height = 4,
  echo = FALSE
)
```




This document outlines the structure of the simulations.



# Model description

Below is the model I'm simulating, for a given line and plant:

$$
\begin{align}
    N_{t+1} &= N_{t} ~ \text{e}^ {\rho + \varepsilon} + I - E \\
    \varepsilon &\sim \text{N}(0,\sigma_p) \\
\end{align}
$$

where... 

- $t$ indexes across time
- $N$ is aphid counts
- $rho$ is the overall growth rate
- $\varepsilon$ is process error
- $I$ is the number of immigrants
- $E$ is the number of emigrants
- $\sigma_p$ is the standard deviation of the process error


The growth rate is determined by whether or not the plant is currently dying,
by population growth rate for a given line, and by the abundances and density dependences
of all lines on the focal plant:

$$
\begin{align}
    \rho_{ijt} &=
        \begin{cases}
            r_j \left( 1 - Z_{it} \right), & \text{if}\ t < \gamma \\
            \log(m(t,\gamma)), & \text{otherwise} \\
        \end{cases} \\
        
    Z_{it} &= \sum^{n_l}_{j=1}{\alpha_j ~ N_{ijt}} \\
    
    m(t,\gamma) &= \text{logit}^{-1}\left(  \beta_{0} + \beta_{1} ~ ( t - \gamma )
        \right) \\
    
\end{align}
$$

where...

- $i$ indexes across plants
- $j$ indexes across aphid lines
- $r$ is the aphid line's growth rate
- $\alpha$ is the aphid line's density dependence
- $\gamma$ is the time at which a plant begins to die
- $m(t,\gamma)$ is the mortality rate caused by plant death, based on the number of days
  after it's started dying
- $n_l$ is the number of aphid lines
- $\beta_0$ and $\beta_1$ are the coefficients for the regression of the
  logit-transformed mortality rate on time since plant-death started


To simulate immigration and emigration, at each time point I first create a 
$n_l$ by $n_p$ matrix, $\mathbf{\lambda}$ (where $n_p$ is the number of plants) of 
dispersal rates by plant and aphid line. I fill this matrix as follows:

$$
    \mathbf{\lambda}_{ij} = \text{e}^{\delta_{0j} + \delta_{1j} ~ \log(N_{ijt})}
$$
where $\delta_0$ and $\delta_1$ are the coefficients for the regression of the
log-transformed dispersal rate on the number of aphids present on a plant.
(Each line has its own estimates for $\delta_0$ and $\delta_1$, hence the $j$ subscript.)

I then use $\mathbf{\lambda}$ to generate numbers of dispersed individuals 
of line $i$ going from from plant $a$ to plant $b$ (where $a \ne b$):

$$
    d_{ia \rightarrow b} \sim \text{Pois} \left( \frac{\mathbf{\lambda}_{ia}}{1 - n_p} \right)
$$

I used these numbers to create two more $n_l$ by $n_p$ matrices,
one for the number of immigrants ($\mathbf{I}$) and another for emigrants
($\mathbf{E}$):

$$
\begin{align}

    \mathbf{I}_{ij} &= \sum^{n_p}_{a \ne j}{d_{ia \rightarrow j}} \\
    
    \mathbf{E}_{ij} &= \sum^{n_p}_{b \ne j}{d_{ij \rightarrow b}} \\
    
\end{align}
$$


## Plant replacement

Plant replacements are simulated by dispersing all aphids from replaced plants to
non-replaced plants.
Replaced plants are started at zero for all lines.

## Extinction

Any time $N_{ij} < 1$, $N_{ij}$ is set to zero and listed as extinct.
$N_{ij}$ is ignored until an aphid of line $j$ immigrates to plant $i$.

