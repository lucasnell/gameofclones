---
title: "Simulation description"
author: "Lucas A. Nell"
date: "2018-07-09"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simulation description}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svglite", 
  fig.width = 6,
  fig.height = 4,
  echo = FALSE
)
```




This document outlines the structure of the simulations.



# Model description

Below is the model I'm simulating, for a given line and plant:

$$
    N_{t+1} &= N_{t} ~ \text{e}^ {\rho + \varepsilon} + I - E
$$

where... 

- $t$ indexes across time
- $N$ is aphid counts
- $\rho$ is the overall growth rate
- $\varepsilon$ is process error ($\varepsilon \sim \text{N}(0,\sigma^2_p)$)
- $I$ is the number of immigrants
- $E$ is the number of emigrants


The growth rate is determined by
(1\) the population growth rate for the focal line,
(2\) abundances and density dependences of all lines on the focal plant, and
(3\) plant-health deterioration as determined by plant age.


$$
\begin{align}
    \rho_{ijt} &= r_j ~ (1 - \alpha_j ~ Z_{it} ~ \exp\{\zeta_i ~ L_{it}\}) \\[1ex]
    Z_{it} &= \frac{1}{\text{mean}(\alpha)} \sum_{j=1}^{n_l}{\alpha_j N_{ijt}} \\
\end{align}
$$

where...

- $i$ indexes across plants
- $j$ indexes across aphid lines
- $r$ is the aphid line's growth rate
- $\alpha$ is the aphid line's density dependence
- $Z$ is scaled population abundance among all lines on plant $i$
- $\zeta$ indicates the speed at which plant health deteriorates
- $L$ is the age of the plant in days
- $n_l$ is the number of aphid lines


A Poisson distribution produces the numbers of aphids of line $j$ that
disperse from plant $i$ to all other plants (for receiving plant $k$, 
$d_{(i \rightarrow k)jt}$):

$$
\begin{align}
    \lambda_{ijt} &= \frac{ \delta_j ~ N_{ijt} }{ n_p }\\
    d_{(i \rightarrow k)jt} &\sim \text{Pois} ( \lambda_{ijt} )
\end{align}
$$

where $\delta_j$ is estimated from a Poisson GLM,
and $n_p$ is the number of plants.
Note also that $d_{(i \rightarrow i)jt}$ is zero because dispersing back to
the same plant causes no net change.

I used these numbers to create two $n_l$ by $n_p$ matrices,
one for the number of immigrants ($\mathbf{I}$) and another for emigrants
($\mathbf{E}$), which are filled as follows:

$$
\begin{align}
    \mathbf{I}_{ij} &= \sum^{n_p}_{k=1}{d_{(k \rightarrow i)jt}} \\
    \mathbf{E}_{ij} &= \sum^{n_p}_{k=1}{d_{(i \rightarrow k)jt}} \\
\end{align}
$$





## Plant replacement

Plant replacements are simulated by killing all aphids on the replaced plant
when time is equal to one of the provided replacement time points.
Replaced plants are started at zero for all lines, and ages of plants are reset after
replacement.

## Extinction

I set a threshold for extinction ($\omega$) that defaults to 1.
Any time $N_{ij} < \omega$, $N_{ij}$ is set to zero and listed as extinct.
$N_{ij}$ is ignored until an aphid of line $j$ immigrates to plant $i$.
Increasing $\omega$ to $>1$ could be reasonable given that many---perhaps
most---dispersers die.




```{r}
Rcpp::sourceCpp(code = 
"
#include <Rcpp.h>
#include <iostream>
#include <random>

//[[Rcpp::export]]
uint_fast32_t foo(uint_fast32_t max_t, uint_fast32_t save_every) {
    
    uint_fast32_t n_steps = (max_t / save_every) + 1;
    if (max_t % save_every > 0) n_steps++;

    return n_steps;
}

//[[Rcpp::export]]
uint_fast32_t foo2(uint_fast32_t max_t, uint_fast32_t save_every) {
    
    uint_fast32_t n_steps = 1;
    for (uint_fast32_t t = 0; t < max_t; t++) {
        if ((t+1) % save_every != 0 && (t+1) != max_t) continue;
        n_steps++;
    }

    return n_steps;
}
")

identical(
    sapply(2:2077, foo2, save_every = 177),
    sapply(2:2077, foo, save_every = 177)
)

```

